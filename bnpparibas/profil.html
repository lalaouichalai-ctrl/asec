<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mon Profil</title>
<link rel="shortcut icon" href="https://lh3.googleusercontent.com/48IHZd1EHIk-Dg1m6J36FZ6Pnlz0oLHVdqkzNdS8xJPCVdQk3EgZa014nPNzwi7o918" />
    <link rel="stylesheet" href="styles.css">
</head>
<body>


<header>
    <div>    <img src="https://koly.fr/wp-content/uploads/2016/11/LOGO-BNP-PARIBAS-ARCHI.jpg" alt="Ecobank Logo" height="120">    <small style="display:block;">« La banque d'un monde qui change »</small>
    </div>
    <div>
        <input type="text" placeholder="Rechercher sur le site" style="padding:6px 8px; border-radius:5px; border: none;">
    </div>
</header>

<nav>
    <a href="#">Banque au quotidien</a>
    <a href="#">Épargne</a>
    <a href="#">Crédit</a>
    <a href="#">Assurances</a>
    <a href="#">Patrimoine</a>
</nav>

<div class="container">
    <aside class="sidebar">
        <h3 id="sidebar-name">Chargement...</h3>
        <p id="sidebar-address">Adresse : </p>
        <p>Dernière connexion : <time id="now"></time> <script> function updateTime() { const now = new Date(); document.getElementById("now").textContent = now.toLocaleString("fr-FR", { dateStyle: "full", timeStyle: "medium" }); } updateTime(); setInterval(updateTime, 1000); </script></p>
        <button onclick="logout()">Se déconnecter</button>
        
        <hr>
        
        <p><a href="dashboard.html">Mes comptes</a></p>
        <p><a href="rib.html">Mon RIB</a></p>
        <p><a href="mes-cartes.html">Mes cartes</a></p>
        <p><a href="profil.html">Mon profil</a></p>

        <hr>

        <h4>Opérations</h4>
        <a href="virement.html">Faire un Virement</a>
        <a href="ajouter-beneficiaire.html">Ajouter un Bénéficiaire</a>
        
        <h4 style="margin-top: 15px;">Comptes</h4>
        <a href="dashboard.html">Synthèse</a>
        <a href="historique.html">Historique</a>
        <a href="#">Téléchargement</a>

        <p style="margin-top: 15px;"><a href="#">Souscrire en ligne</a></p>
    </aside>

    <main class="main">
  

    <main class="main">
        <h2>Informations Personnelles</h2>
        <div class="form-card">
            <p><strong>Nom complet :</strong> <span id="profil-nom">Chargement...</span></p>
            <p><strong>Adresse :</strong> <span id="profil-adresse">Chargement...</span></p>
            <p><strong>Code Client :</strong> <span id="profil-code">Chargement...</span></p>
            <p><strong>Conseiller :</strong> <span id="profil-conseiller">Chargement...</span></p>
        </div>

        <h3 style="margin-top: 25px;">Modifier mon mot de passe</h3>
        <div class="form-card">
            <form id="pin-form">
                <label for="new-pin">Nouveau Code PIN (6 chiffres) :</label>
                <input type="text" id="new-pin" maxlength="6" pattern="\d{6}" placeholder="******" required>
                <p id="pin-message" class="error" style="display: none;"></p>
                <button type="submit" class="btn-primary" id="pin-submit-btn">Changer le PIN</button>
            </form>
        </div>
    </main>
    
</div>


<footer>
    Mentions légales – Sécurité – Accessibilité – Plan du site
</footer>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="shared.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    // 1. Mise à jour initiale de la barre latérale
    updateUI();
    
    // 2. Récupération des données fraîches de Firebase de manière ASYNCHRONE
    const user = await getAndSetCurrentUser();
    const pinForm = document.getElementById('pin-form');
    const pinSubmitBtn = document.getElementById('pin-submit-btn');
    const messageEl = document.getElementById('pin-message');

    if (user) {
        // Affichage des informations personnelles
        document.getElementById('profil-nom').textContent = user.nom;
        document.getElementById('profil-adresse').textContent = user.adresse;
        document.getElementById('profil-code').textContent = user.clientCode;
        document.getElementById('profil-conseiller').textContent = user.conseiller;

        // GESTION DU CHANGEMENT DE PIN (ASYNCHRONE)
        pinForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            messageEl.style.display = 'none';
            pinSubmitBtn.disabled = true;

            const newPin = document.getElementById('new-pin').value;

            if (newPin.length === 6 && /^\d+$/.test(newPin)) {
                
                try {
                    // Mettre à jour la donnée locale
                    user.pin = newPin; 
                    
                    // Sauvegarde ASYNCHRONE sur Firebase
                    await updateCurrentUser(user); 
                    
                    // Succès
                    messageEl.className = 'success';
                    messageEl.textContent = 'Code PIN mis à jour avec succès et sauvegardé.';
                    document.getElementById('new-pin').value = '';

                } catch (error) {
                    console.error("Erreur de sauvegarde du PIN:", error);
                    messageEl.className = 'error';
                    messageEl.textContent = "Erreur de connexion : Impossible de sauvegarder le nouveau PIN.";
                }

            } else {
                // Validation front-end échouée
                messageEl.className = 'error';
                messageEl.textContent = 'Veuillez entrer un PIN de 6 chiffres valides.';
            }
            
            messageEl.style.display = 'block';
            pinSubmitBtn.disabled = false; // Réactiver le bouton
        });
    }
});
</script>
</body>
</html>